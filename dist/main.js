!function(t){var e={};function i(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(o,n,function(e){return t[e]}.bind(null,n));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class o extends Error{constructor(t){super(t.errcode+": "+t.error),this.errcode=t.errcode,this.error=t.error,this.details=t}}async function n(t,e,i,n){if(i){-1==t.indexOf("?")&&(t+="?");for(let e in i){let o=i[e];o instanceof Object&&(o=JSON.stringify(o)),t.endsWith("?")||(t+="&"),t+=encodeURIComponent(e)+"="+encodeURIComponent(o)}}"GET"!=e.method&&(e.headers=e.headers||{},e.headers["Content-Type"]="application/json",e.body=JSON.stringify(n||{}));let s=await fetch(t,e),r=await s.json();if(s.status>=400&&s.status<500&&r.errcode)throw new o(r);return r}function s(t){let e=t.match(/^@([^:]*):(.*)$/);if(!e)throw Error("user_id must match pattern @<user>:<matrix-host>");return{username:e[1],host:"https://"+e[2]}}function r(t){return JSON.parse(JSON.stringify(t))}function c(t){let e=[];for(let i in t)e.push(i);return e}const a="com.github.flackr.lobby.User";class l{constructor(t){this.options_=t||{},this.options_.defaultHost=this.options_.defaultHost||"https://matrix.org",this.options_.appName=this.options_.appName||window.location.origin+window.location.pathname,this.client_=null}async reauthenticate(){let t=localStorage.getItem(a);if(!t)return null;let e=JSON.parse(t);return this.client=new h(this,e,e.type)}async login(t,e){let i=t.startsWith("@")?s(t):{username:t,host:this.options_.defaultHost},o=i.username,r=await n(i.host+"/_matrix/client/r0/login",{method:"POST"},null,{type:"m.login.password",identifier:{type:"m.id.user",user:o},password:e,initial_device_display_name:"Lobby Client"});return this.client=new h(this,r,"user")}async register(t,e){let i,o=t.startsWith("@")?s(t):{username:t,host:this.options_.defaultHost},r={username:o.username,password:e,initial_device_display_name:"Lobby Client"},c=0;for(;;){c++;let t=await n(o.host+"/_matrix/client/r0/register",{method:"POST"},null,r);if(t.access_token){i=t;break}if(c>=2)throw Error("Failed to register after dummy authentication");let e=0;for(e=0;e<t.flows.length&&(1!=t.flows[e].stages.length||"m.login.dummy"!=t.flows[e].stages[0]);e++);if(e==t.flows.length)throw Error("Matrix server does not support password only registration.");r.auth={session:t.session,type:"m.login.dummy"}}return this.client=new h(this,i,"user")}async loginAsGuest(t){let e=await n((t||this.options_.defaultHost)+"/_matrix/client/r0/register",{method:"POST"},{kind:"guest"});return this.client=new h(this,e,"guest")}set client(t){let e=this.client_;return this.client_=t,e&&e.logout(),this.client_?localStorage.setItem(a,JSON.stringify({access_token:this.client_.access_token,user_id:this.client_.user_id,type:this.client_.type})):localStorage.removeItem(a),this.client_}get client(){return this.client_}}class h{constructor(t,e,i){this.service_=t,this.access_token=e.access_token,this.user_id=e.user_id,this.type=i,this.txnCtr_=0;let o=s(this.user_id);this.host_=o.host,this.lobby_=null}async lobby(){return this.service_.options_.lobbyRoom?(this.lobby_||(this.lobby_=await new u(this,this.service_.options_.lobbyRoom)),this.lobby_):null}logout(){if(this.service_&&this.service_.client==this)return this.service_.client=null,void(this.service_=null);this.access_token&&("guest"==this.type?this.fetch("/_matrix/client/r0/account/deactivate","POST"):this.user_id&&this.fetch("/_matrix/client/r0/logout","POST"),this.access_token="")}async fetch(t,e,i,o){return n(this.host_+t,{method:e,headers:{Authorization:"Bearer "+this.access_token}},i,o)}async joinedRoomStates(t){let e=(await this.fetch("/_matrix/client/r0/sync?","GET",{filter:{room:{state:{types:["m.room.topic","com.github.flackr.lobby.Game"]},timeline:{types:[]}}}})).rooms.join,i={};for(let t in e){let o={},n=e[t].state.events;for(let t=0;t<n.length;t++)o[n[t].type]=n[t].content;o["com.github.flackr.lobby.Game"]&&o["com.github.flackr.lobby.Game"].tag==this.service_.options_.appName&&(i[t]=o)}return i}view(t){return new m(this,t)}async join(t){let e=new m(this,t);return await e.join(),e}async create(t){return t=t||{},(await this.fetch("/_matrix/client/r0/createRoom","POST",null,{visibility:"private",preset:"public_chat",name:t.name||"Unnamed",topic:t.topic||"Default Lobby Topic",initial_state:[{type:"com.github.flackr.lobby.Game",content:{url:window.location.origin+window.location.pathname,tag:this.service_.options_.appName}},{type:"m.room.guest_access",content:{guest_access:"can_join"}},{type:"m.room.history_visibility",content:{history_visibility:"world_readable"}}]})).room_id}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr_++}}class m{constructor(t,e){this.client_=t,this.room_id=e,this.timeout_=3e4,this.joined=!1,this.initialSync_=!0,this.state_=new d,this.syncParams_={filter:{room:{rooms:[this.room_id]}}}}get connected(){return this.client_.access_token}async join(){let t=await this.client_.fetch("/_matrix/client/r0/join/"+encodeURI(this.room_id),"POST");this.room_id=t.room_id,this.joined=!0,this.state_.reset()}async leave(){await this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/leave","POST")}async members(){return(await this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/members","GET")).chunk}setTimelineTypes(t){this.syncParams_.filter.room.timeline.types=t}setStateTypes(t){this.syncParams_.filter.room.state.types=t}async sync(){let t=await this.client_.fetch("/_matrix/client/r0/sync?","GET",this.syncParams_);this.syncParams_.since=t.next_batch;let e=t.rooms.join[this.room_id];e&&this.state_.process(e.state.events);let i={state:e?e.state.events:[],timeline:e?e.timeline.events:[]};if(e&&this.initialSync_){let o=e.timeline.prev_batch,n=r(this.syncParams_);for(n.dir="b";o&&(n.from=o,0!=(t=await this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/messages","GET",n)).chunk.length);)i.timeline=t.chunk.reverse().concat(i.timeline),o=i.prev_batch}return this.syncParams_.timeout=this.timeout_,this.initialSync_=!1,i}async fetchEvents(){return(await this.sync()).timeline}async sendEvent(t,e){let i=this.client_.makeTxnId();return(await this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/send/"+encodeURI(t)+"/"+encodeURI(i),"PUT",null,e)).event_id}async state(){if(!this.joined&&this.state_.empty){let t=await this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/state","GET");this.state_.process(t)}return this.state_}}class d{constructor(t){this.reset()}reset(){this.empty=!0,this.state={}}process(t){this.empty=!1;for(let e=0;e<t.length;e++)t[e].state_key?(this.state[t[e].type]=this.state[t[e].type]||{},this.state[t[e].type][t[e].state_key]=t[e]):this.state[t[e].type]=t[e]}activeMembers(){let t={};for(let e in this.state["m.room.member"]){let i=this.state["m.room.member"][e];"join"==i.content.membership&&(t[i.user_id]={displayname:i.content.displayname})}return t}}class u extends m{constructor(t,e){super(t,e),this.cleanup_=!0,this.initialFetch_=!0,this.rooms={},this.roomCount=0,this.syncStates_=["m.room.topic","com.github.flackr.lobby.Game"],this.prev_batch="",this.next_bacth="",this.fetchAmount_=20,this.lobbySyncParams_={filter:{room:{rooms:[this.room_id],state:{types:[]},timeline:{}}}}}async advertise(t){let e=t;e.msgtype="m.text",e.body="Created game at "+t.url,e.tag=this.client_.service_.options_.appName,await this.sendEvent("m.room.message",e)}async syncRooms(t){let e=null;if(t){if(this.initialFetch_)throw new Error("No prev_batch token yet, sync in forwards direction first");let t=r(this.lobbySyncParams_);t.from=this.prev_batch,t.dir="b",t.limit=this.fetchAmount_;let i=await this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/messages","GET",t);if(this.prev_batch=i.end,0==(e=i.chunk).length)return null}else{let t=r(this.lobbySyncParams_);this.next_batch?(t.since=this.next_batch,t.timeout=this.timeout_):t.filter.room.timeline.limit=this.fetchAmount_;let i=await this.client_.fetch("/_matrix/client/r0/sync?","GET",t);this.next_batch=i.next_batch,this.syncParams_.timeout=this.timeout_;let o=i.rooms.join[this.room_id];this.initialFetch_&&(this.initialFetch_=!1,o&&(this.prev_batch=o.timeline.prev_batch)),e=o&&o.timeline.events||[]}let i=[];for(let t=0;t<e.length;t++)e[t].content.tag==this.client_.service_.options_.appName&&e[t].content.room_id&&i.push({event:e[t],room:this.gameInfo(e[t].content.room_id)});let o=[];for(let t=0;t<i.length;t++){let e=!1;try{let n=await i[t].room;c(n.state_.activeMembers()).length>0?o.push(n):e=!0}catch(t){console.warn("Skipping game due to error fetching details",t)}if(e){let e=i[t].event,o=this.client_.makeTxnId();this.client_.fetch("/_matrix/client/r0/rooms/"+encodeURI(this.room_id)+"/redact/"+encodeURI(e.event_id)+"/"+encodeURI(o),"PUT")}}return o}async gameInfo(t){let e=this.client_.view(t);return await e.state(),e}}let p,_;document.addEventListener("DOMContentLoaded",(async function(){(v=localStorage.getItem("user_id"))||(v="user"+Math.floor(1e6*Math.random()),localStorage.setItem("user_id",v));console.log(v),b=function(){var t={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(e,i,o){t[i]=o}));return t}().admin,console.log(b),function(){w("#add-topic").addEventListener("click",(function(){O("page-add")})),w("#cancel-add-topic").addEventListener("click",(function(t){O("page-main"),t.preventDefault()})),w("#formNewTopic").onsubmit=function(t){t.preventDefault(),async function(){await _.sendEvent("m.room.message",{body:"Adding room: "+w("#newTopicTitle").value,msgtype:"m.text",newlyAddedTopic:w("#newTopicTitle").value,newlyAddedTopicDescription:w("#newTopicDescription").value,user_id:v}),O("page-main")}()};let t=document.getElementById("mdc-tab-4");t.addEventListener("click",S),(t=document.getElementById("mdc-tab-5")).addEventListener("click",k),(t=document.getElementById("mdc-tab-6")).addEventListener("click",E)}();let t=await async function(t){return new l(t)}();(p=await t.reauthenticate())||(p=await t.login(f,g));!async function(t){for(;;){let e=await t.fetchEvents();for(let t of e)if(console.log(t),t.content.newlyAddedTopic){t.content.user_id=v;let e=w("#templates ."+"topic").cloneNode(!0),i=t.content.newlyAddedTopic;e.topic=i,e.creator=t.content.user_id,e.upvotes=new Set([]),e.ignored=new Set([]),e.querySelector(".topic-title").textContent=i;let o=t.content.newlyAddedTopicDescription||"No description";e.querySelector(".topic-description").textContent=o;let n=e.querySelector(".ignore");n.topic=i,n.addEventListener("click",C);let s=e.querySelector(".upvote");if(s.topic=i,s.addEventListener("click",j),b){let t=e.querySelector(".topic-icon");t.topic=i,t.addEventListener("click",N)}w("#topic-list").appendChild(e),I()}else if(t.content.delete_topic){let e=T(t.content.topic);e&&w("#topic-list").removeChild(e)}else(t.content.vote_ignore||t.content.vote_upvote)&&P(t.content.topic,t.content.user_id,t.content.vote_ignore,t.content.vote_upvote)}}(_=await p.join(y))}));const y="!zIlIGXfNAskJbYZvgO:matrix.org",f="topic-bot",g="riot.IM.PASSWORD";let v,b;function w(t){return document.querySelector(t)}function T(t){let e=w("#topic-list");for(var i in e.children){let o=e.children[i];if(o.topic==t)return o}console.log(0&t)}let x={showNeedsVote:!0,showMyTopics:!1,showTopTopics:!1};function S(){x.showNeedsVote=!0,x.showMyTopics=!1,x.showTopTopics=!1,I()}function k(){x.showNeedsVote=!1,x.showMyTopics=!0,x.showTopTopics=!1,I()}function E(){x.showNeedsVote=!1,x.showMyTopics=!1,x.showTopTopics=!0,I()}function I(){let t=w("#topic-list");for(var e=0;e<t.children.length;e++){let i,o=t.children[e],n=o.querySelector(".topic-title");if(x.showNeedsVote?(i=!(o.ignored.has(v)||o.upvotes.has(v)),n.textContent=o.topic):x.showMyTopics?(i=o.creator==v,n.textContent=o.topic):x.showTopTopics&&(i=o.upvotes.size>=1,n.textContent="["+o.upvotes.size+"] "+o.topic),i){o.classList.add("visible"),o.classList.remove("display:none"),o.style.display="";let t=o.querySelector(".mdl-list__item-avatar");o.upvotes.size>1?t.textContent="people":o.upvotes.size>1?t.textContent="people":t.textContent="person-outline"}else o.style.display="none"}}function P(t,e,i,o){let n=T(t);n&&(i&&(n.upvotes.delete(e),n.ignored.add(e)),o&&(n.ignored.delete(e),n.upvotes.add(e)),I())}function O(t){document.querySelector(".app-page.visible").classList.remove("visible"),document.getElementById(t).classList.add("visible")}async function N(t){let e=t.target.topic||t.target.parentNode.topic;console.log("Delete "+e),await _.sendEvent("m.room.message",{body:"Delete topic: "+e+" ("+v+")",msgtype:"m.text",topic:e,delete_topic:!0,user_id:v})}async function j(t){let e=t.target.topic||t.target.parentNode.topic;console.log("Upvote "+e),await _.sendEvent("m.room.message",{body:"Upvote on topic: "+e+" ("+v+")",msgtype:"m.text",topic:e,vote_upvote:!0,user_id:v})}async function C(t){let e=t.target.topic||t.target.parentNode.topic;console.log("Ignoring..."),console.log(t),await _.sendEvent("m.room.message",{body:"Ignore topic: "+e+" ("+v+")",msgtype:"m.text",topic:e,vote_ignore:!0,user_id:v})}}]);